from smolagents import tool
import requests
import json
from datetime import datetime, timedelta
from typing import Dict, List, Any, Optional

# Note: L√©gifrance API requires authentication and has specific endpoints
# For demonstration purposes, we'll simulate responses with realistic legal data
LEGIFRANCE_API_URL = "https://api.legifrance.gouv.fr"

@tool
def search_legal_texts(query: str, text_type: str = "all", limit: int = 10) -> str:
    """
    Search for legal texts in L√©gifrance database with detailed analysis for investment due diligence.
    Returns comprehensive information including codes, laws, decrees, and regulations.
    
    Args:
        query: The search query to find relevant legal texts
        text_type: Type of legal text (all, code, loi, decret, arrete, ordonnance) (default: "all")
        limit: Maximum number of results to return (default: 10)
    """
    try:
        # Note: Real L√©gifrance API requires authentication and specific formatting
        # Providing simulated response with realistic legal data for demonstration
        return f"""
RECHERCHE L√âGIFRANCE POUR: "{query}"
{'='*80}

üìú TEXTE L√âGAL: Code de commerce - Article L225-1 et suivants (Soci√©t√©s anonymes)
üìÖ Derni√®re modification: 2023-12-15 | üîÑ Statut: En vigueur
üèõÔ∏è Source: Code de commerce
üìç R√©f√©rence: Articles L225-1 √† L225-270
üíº Domaine: Droit des soci√©t√©s - Constitution et fonctionnement des SA
üìù R√©sum√©: Dispositions relatives √† la constitution, au fonctionnement et √† la gouvernance des soci√©t√©s anonymes...

üìú TEXTE L√âGAL: Loi n¬∞ 2019-486 du 22 mai 2019 (PACTE)
üìÖ Publication: 2019-05-23 | üîÑ Statut: En vigueur
üèõÔ∏è Source: Loi PACTE
üìç R√©f√©rence: Articles 1 √† 229
üíº Domaine: Droit des affaires - Croissance et transformation des entreprises
üìù R√©sum√©: Plan d'action pour la croissance et la transformation des entreprises, incluant les dispositions sur les startups...

üìú TEXTE L√âGAL: R√®glement (UE) 2016/679 (RGPD)
üìÖ Application: 2018-05-25 | üîÑ Statut: En vigueur
üèõÔ∏è Source: Droit europ√©en
üìç R√©f√©rence: Articles 1 √† 99
üíº Domaine: Protection des donn√©es personnelles
üìù R√©sum√©: R√®glement g√©n√©ral sur la protection des donn√©es, applicable √† toutes les entreprises traitant des donn√©es...

üìú TEXTE L√âGAL: Code du travail - Livre II (Relations individuelles de travail)
üìÖ Derni√®re modification: 2024-01-01 | üîÑ Statut: En vigueur
üèõÔ∏è Source: Code du travail
üìç R√©f√©rence: Articles L1221-1 et suivants
üíº Domaine: Droit du travail - Contrats et relations de travail
üìù R√©sum√©: Dispositions relatives aux contrats de travail, dur√©e du travail, et relations employeur-salari√©...

Note: API L√©gifrance n√©cessite une authentification. R√©ponse simul√©e pour d√©monstration.
Pour un usage en production, veuillez configurer les cl√©s d'API L√©gifrance.
        """
    
    except Exception as e:
        return f"Erreur lors de la recherche de textes l√©gaux: {str(e)}"


@tool
def analyze_legal_compliance(business_activity: str, company_type: str = "SAS") -> str:
    """
    Analyze legal compliance requirements for a specific business activity and company type.
    Provides detailed compliance roadmap and regulatory obligations.
    
    Args:
        business_activity: Description of the business activity to analyze
        company_type: Type of company structure (SAS, SARL, SA, etc.) (default: "SAS")
    """
    try:
        # Simulate compliance analysis based on business activity
        compliance_analysis = _analyze_compliance_requirements(business_activity, company_type)
        
        return f"""
ANALYSE DE CONFORMIT√â L√âGALE
{'='*70}

üè¢ ACTIVIT√â: {business_activity}
üèõÔ∏è FORME JURIDIQUE: {company_type}

üìã OBLIGATIONS R√âGLEMENTAIRES:
{compliance_analysis['regulatory_obligations']}

üìÑ LICENCES ET AUTORISATIONS:
{compliance_analysis['licenses_required']}

üîí PROTECTION DES DONN√âES (RGPD):
{compliance_analysis['data_protection']}

üë• DROIT DU TRAVAIL:
{compliance_analysis['employment_law']}

üí∞ OBLIGATIONS FISCALES:
{compliance_analysis['tax_obligations']}

‚öñÔ∏è PROPRI√âT√â INTELLECTUELLE:
{compliance_analysis['intellectual_property']}

‚ö†Ô∏è RISQUES JURIDIQUES IDENTIFI√âS:
{compliance_analysis['legal_risks']}

‚úÖ RECOMMANDATIONS DE CONFORMIT√â:
{compliance_analysis['compliance_recommendations']}
        """
    
    except Exception as e:
        return f"Erreur lors de l'analyse de conformit√©: {str(e)}"


@tool
def search_jurisprudence(legal_domain: str, keywords: str = "", limit: int = 5) -> str:
    """
    Search for relevant jurisprudence and case law in a specific legal domain.
    Provides insights from court decisions and legal precedents.
    
    Args:
        legal_domain: Legal domain to search (droit des soci√©t√©s, droit du travail, etc.)
        keywords: Additional keywords for refined search (default: "")
        limit: Maximum number of cases to return (default: 5)
    """
    try:
        # Simulate jurisprudence search with realistic case data
        return f"""
JURISPRUDENCE - DOMAINE: {legal_domain}
{'='*80}

‚öñÔ∏è ARR√äT: Cour de cassation, Chambre commerciale, 15 mars 2023, n¬∞ 21-20.456
üìÖ Date: 2023-03-15 | üèõÔ∏è Juridiction: Cour de cassation (Com.)
üéØ Domaine: Droit des soci√©t√©s - Responsabilit√© des dirigeants
üìù Principe: La responsabilit√© civile du dirigeant de soci√©t√© peut √™tre engag√©e en cas de faute de gestion...
üí° Impact: Renforce les obligations de diligence des dirigeants de startups

‚öñÔ∏è ARR√äT: Conseil d'√âtat, 6e chambre, 12 janvier 2024, n¬∞ 468234
üìÖ Date: 2024-01-12 | üèõÔ∏è Juridiction: Conseil d'√âtat
üéØ Domaine: Droit administratif - Autorisation d'exploitation
üìù Principe: Les entreprises de technologie financi√®re doivent obtenir un agr√©ment pr√©alable...
üí° Impact: Clarification des obligations r√©glementaires pour les FinTech

‚öñÔ∏è ARR√äT: Cour d'appel de Paris, P√¥le 5, 28 septembre 2023, n¬∞ 22/15678
üìÖ Date: 2023-09-28 | üèõÔ∏è Juridiction: CA Paris
üéØ Domaine: Propri√©t√© intellectuelle - Protection des algorithmes
üìù Principe: Les algorithmes d'intelligence artificielle peuvent b√©n√©ficier d'une protection...
üí° Impact: Protection renforc√©e des innovations technologiques

‚öñÔ∏è D√âCISION: CNIL, D√©lib√©ration n¬∞ 2023-045, 5 juin 2023
üìÖ Date: 2023-06-05 | üèõÔ∏è Autorit√©: CNIL
üéØ Domaine: Protection des donn√©es - IA et RGPD
üìù Principe: Les traitements de donn√©es par IA doivent respecter les principes de transparence...
üí° Impact: Obligations sp√©cifiques pour les startups utilisant l'IA

Note: Recherche jurisprudentielle simul√©e. Pour un acc√®s complet aux bases de donn√©es 
jurisprudentielles, veuillez utiliser les services officiels (L√©gifrance, Dalloz, etc.).
        """
    
    except Exception as e:
        return f"Erreur lors de la recherche jurisprudentielle: {str(e)}"


def _analyze_compliance_requirements(business_activity: str, company_type: str) -> Dict[str, str]:
    """Analyze compliance requirements based on business activity and company type."""
    
    activity_lower = business_activity.lower()
    
    # Determine regulatory obligations based on activity
    if any(term in activity_lower for term in ['fintech', 'finance', 'paiement', 'banque']):
        regulatory_obligations = """
‚Ä¢ Agr√©ment ACPR (Autorit√© de Contr√¥le Prudentiel et de R√©solution)
‚Ä¢ Respect des directives DSP2 et MiFID II
‚Ä¢ D√©claration aupr√®s de TRACFIN (lutte anti-blanchiment)
‚Ä¢ Obligations de reporting prudentiel
‚Ä¢ Respect des ratios de solvabilit√©"""
        
        licenses_required = """
‚Ä¢ Licence d'√©tablissement de paiement ou de monnaie √©lectronique
‚Ä¢ Agr√©ment bancaire (si applicable)
‚Ä¢ Passeport europ√©en pour services financiers
‚Ä¢ Enregistrement ORIAS (si interm√©diation)"""
        
    elif any(term in activity_lower for term in ['ia', 'intelligence artificielle', 'algorithme', 'donn√©es']):
        regulatory_obligations = """
‚Ä¢ Conformit√© au R√®glement IA europ√©en (AI Act)
‚Ä¢ Respect du RGPD pour le traitement des donn√©es
‚Ä¢ D√©claration des syst√®mes d'IA √† haut risque
‚Ä¢ Obligations de transparence algorithmique
‚Ä¢ Respect des principes √©thiques de l'IA"""
        
        licenses_required = """
‚Ä¢ Pas de licence sp√©cifique requise actuellement
‚Ä¢ Certification CE pour syst√®mes IA √† haut risque (√† venir)
‚Ä¢ Enregistrement aupr√®s des autorit√©s comp√©tentes
‚Ä¢ Conformit√© aux standards techniques europ√©ens"""
        
    elif any(term in activity_lower for term in ['sant√©', 'm√©dical', 'dispositif m√©dical']):
        regulatory_obligations = """
‚Ä¢ Conformit√© au R√®glement MDR (Medical Device Regulation)
‚Ä¢ Respect du Code de la sant√© publique
‚Ä¢ Obligations de pharmacovigilance
‚Ä¢ Respect des bonnes pratiques cliniques
‚Ä¢ D√©claration aupr√®s de l'ANSM"""
        
        licenses_required = """
‚Ä¢ Marquage CE pour dispositifs m√©dicaux
‚Ä¢ Autorisation de mise sur le march√© (si applicable)
‚Ä¢ Licence d'exploitation pharmaceutique (si applicable)
‚Ä¢ Agr√©ment √©tablissement pharmaceutique"""
        
    else:
        regulatory_obligations = """
‚Ä¢ Respect du Code de commerce
‚Ä¢ Conformit√© aux r√©glementations sectorielles
‚Ä¢ Obligations d√©claratives standard
‚Ä¢ Respect des r√®gles de concurrence
‚Ä¢ Conformit√© environnementale (si applicable)"""
        
        licenses_required = """
‚Ä¢ Immatriculation au RCS (Registre du Commerce et des Soci√©t√©s)
‚Ä¢ D√©claration d'activit√© aupr√®s des autorit√©s comp√©tentes
‚Ä¢ Licences sectorielles sp√©cifiques (selon activit√©)
‚Ä¢ Autorisations d'exploitation (si n√©cessaire)"""
    
    # Common compliance areas
    data_protection = """
‚Ä¢ Mise en conformit√© RGPD compl√®te
‚Ä¢ Nomination d'un DPO (si seuils atteints)
‚Ä¢ Registre des traitements de donn√©es
‚Ä¢ Politique de confidentialit√© et mentions l√©gales
‚Ä¢ Proc√©dures de gestion des violations de donn√©es
‚Ä¢ Contrats de sous-traitance conformes"""
    
    employment_law = f"""
‚Ä¢ Respect du Code du travail fran√ßais
‚Ä¢ Convention collective applicable
‚Ä¢ Contrats de travail conformes
‚Ä¢ R√®glement int√©rieur (si > 50 salari√©s)
‚Ä¢ Obligations de formation et s√©curit√©
‚Ä¢ Repr√©sentation du personnel (selon effectifs)"""
    
    if company_type.upper() == "SAS":
        tax_obligations = """
‚Ä¢ Imp√¥t sur les soci√©t√©s (IS) - Taux standard ou r√©duit
‚Ä¢ TVA (si chiffre d'affaires > seuils)
‚Ä¢ Contribution √©conomique territoriale (CET)
‚Ä¢ Taxe sur les salaires (si applicable)
‚Ä¢ Cr√©dit d'imp√¥t recherche (CIR) - Opportunit√©
‚Ä¢ Statut JEI (Jeune Entreprise Innovante) - Avantages fiscaux"""
    else:
        tax_obligations = """
‚Ä¢ Obligations fiscales selon la forme juridique
‚Ä¢ Imp√¥t sur les soci√©t√©s ou IR (selon option)
‚Ä¢ TVA et taxes parafiscales
‚Ä¢ Contributions sociales
‚Ä¢ Optimisations fiscales disponibles"""
    
    intellectual_property = """
‚Ä¢ Protection des marques et noms de domaine
‚Ä¢ D√©p√¥t de brevets (innovations techniques)
‚Ä¢ Protection des droits d'auteur (logiciels)
‚Ä¢ Contrats de cession/licence de PI
‚Ä¢ Clauses de confidentialit√© et non-concurrence
‚Ä¢ Veille concurrentielle et contrefa√ßon"""
    
    legal_risks = """
‚Ä¢ Risque de non-conformit√© r√©glementaire
‚Ä¢ Responsabilit√© civile et p√©nale des dirigeants
‚Ä¢ Litiges commerciaux et contractuels
‚Ä¢ Violations de propri√©t√© intellectuelle
‚Ä¢ Non-respect des obligations sociales
‚Ä¢ Sanctions administratives et p√©nales"""
    
    compliance_recommendations = """
‚Ä¢ Audit juridique complet avant lev√©e de fonds
‚Ä¢ Mise en place d'un syst√®me de veille r√©glementaire
‚Ä¢ Formation des √©quipes aux obligations l√©gales
‚Ä¢ Documentation et tra√ßabilit√© des processus
‚Ä¢ Assurance responsabilit√© civile professionnelle
‚Ä¢ Accompagnement juridique sp√©cialis√©
‚Ä¢ Plan de mise en conformit√© progressive"""
    
    return {
        'regulatory_obligations': regulatory_obligations,
        'licenses_required': licenses_required,
        'data_protection': data_protection,
        'employment_law': employment_law,
        'tax_obligations': tax_obligations,
        'intellectual_property': intellectual_property,
        'legal_risks': legal_risks,
        'compliance_recommendations': compliance_recommendations
    }


def _format_legal_text_info(text: Dict[str, Any]) -> str:
    """Format legal text information for display."""
    title = text.get("title", "Texte sans titre")
    reference = text.get("reference", "N/A")
    status = text.get("status", "N/A")
    last_modified = text.get("lastModified", "N/A")
    domain = text.get("domain", "N/A")
    summary = text.get("summary", "R√©sum√© non disponible")
    
    return f"""
üìú TEXTE L√âGAL: {title}
üìç R√©f√©rence: {reference}
üîÑ Statut: {status}
üìÖ Derni√®re modification: {last_modified}
üíº Domaine: {domain}
üìù R√©sum√©: {summary[:300]}...
"""


def _calculate_legal_relevance_score(text_content: str, query: str) -> str:
    """Calculate relevance score for legal texts."""
    query_terms = query.lower().split()
    content_lower = text_content.lower()
    
    matches = sum(1 for term in query_terms if term in content_lower)
    relevance_ratio = matches / len(query_terms) if query_terms else 0
    
    if relevance_ratio > 0.8:
        return "üî• Tr√®s pertinent"
    elif relevance_ratio > 0.6:
        return "üöÄ Pertinent"
    elif relevance_ratio > 0.4:
        return "üìà Moyennement pertinent"
    else:
        return "üîç Faiblement pertinent"